generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id               String            @id @default(uuid())
  name             String
  slug             String            @unique
  subscriptionPlan String            @default("FREE_PILOT")
  isActive         Boolean           @default(true)
  logo             String?
  address          String?
  phone            String?
  email            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  chatMessages     ChatMessage[]
  clients          Client[]
  custodyTransfers CustodyTransfer[]
  documents        Document[]
  materialBatches  MaterialBatch[]
  materialUsage    MaterialUsage[]
  materials        Material[]
  notes            Note[]
  notifications    Notification[]
  projects         Project[]
  roles            Role[]
  suppliers        Supplier[]
  transactions     Transaction[]
  users            User[]
  workmanships     Workmanship[]
  workmen          Workman[]

  @@map("tenants")
}

model User {
  id                    String            @id @default(uuid())
  email                 String
  password              String
  name                  String
  role                  UserRole          @default(ENGINEER)
  company               String?
  phone                 String?
  isActive              Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  currentCustodyBalance Decimal           @default(0) @db.Decimal(15, 2)
  pendingClearance      Decimal           @default(0) @db.Decimal(15, 2)
  profilePicture        String?
  tenantId              String?
  isVerified            Boolean           @default(false)
  verificationCode      String?
  verificationExpires   DateTime?
  mustChangePassword    Boolean           @default(false)
  permissions           String[]          @default([])
  resetPasswordExpire   DateTime?
  resetPasswordToken    String?
  roleId                String?
  chatMessages          ChatMessage[]
  custodyTransfers      CustodyTransfer[]
  materialBatches       MaterialBatch[]
  materialUsage         MaterialUsage[]
  notifications         Notification[]
  projects              Project[]
  approvedTransactions  Transaction[]     @relation("ApprovedBy")
  transactions          Transaction[]
  customRole            Role?             @relation(fields: [roleId], references: [id], onDelete: SetNull)
  tenant                Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workmanships          Workmanship[]

  @@unique([email, tenantId])
  @@unique([phone, tenantId])
  @@map("users")
}

/// Dynamic Role-Based Access Control (RBAC) Model
model Role {
  id          String   @id @default(uuid())
  name        String   // e.g., "Senior Engineer", "Site Clerk", "Junior Accountant"
  description String?
  isSystem    Boolean  @default(false) // If true, cannot be deleted (e.g., Admin, Engineer)
  
  /// The Permission Matrix: Stored as JSON for flexibility
  /// Example: { "financials": { "view_operational_fund": true, "view_office_profit": false }, ... }
  permissions Json     
  
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name]) // Role names must be unique per company
  @@map("roles")
}

model Client {
  id              String        @id @default(uuid())
  name            String
  email           String
  phone           String
  company         String?
  taxId           String?
  status          ClientStatus  @default(ACTIVE)
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  contactName     String?
  contactPosition String?
  contactPhone    String?
  contactEmail    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  tenantId        String?
  tenant          Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects        Project[]
  transactions    Transaction[]

  @@map("clients")
}

model Supplier {
  id           String           @id @default(uuid())
  name         String
  email        String
  phone        String
  company      String?
  category     SupplierCategory @default(OTHER)
  taxId        String?
  paymentTerms String           @default("Net 30")
  rating       Int              @default(3)
  status       SupplierStatus   @default(ACTIVE)
  street       String?
  city         String?
  state        String?
  zipCode      String?
  country      String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  tenantId     String?
  materials    Material[]
  tenant       Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("suppliers")
}

model Project {
  id                   String          @id @default(uuid())
  name                 String
  description          String?
  status               ProjectStatus   @default(PLANNING)
  projectType          ProjectType     @default(OTHER)
  location             String?
  startDate            DateTime
  endDate              DateTime?
  budget               Decimal         @db.Decimal(15, 2)
  actualCost           Decimal         @default(0) @db.Decimal(15, 2)
  clientId             String
  engineerId           String
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  managementFeePercent Decimal?        @db.Decimal(5, 2)
  officeRevenue        Decimal         @default(0) @db.Decimal(15, 2)
  operationalFund      Decimal         @default(0) @db.Decimal(15, 2)
  paymentTerms         String          @default("Net 30")
  revenueModel         RevenueModel    @default(EXECUTION_COST_PLUS)
  tenantId             String?
  totalContractValue   Decimal?        @db.Decimal(15, 2)
  documents            Document[]
  materialBatches      MaterialBatch[]
  materialUsage        MaterialUsage[]
  notes                Note[]
  client               Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  engineer             User            @relation(fields: [engineerId], references: [id])
  tenant               Tenant?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions         Transaction[]
  workmanships         Workmanship[]

  @@map("projects")
}

model Material {
  id           String          @id @default(uuid())
  name         String
  nameAr       String?
  description  String?
  unit         MaterialUnit
  stockLevel   Decimal         @default(0) @db.Decimal(10, 2)
  unitPrice    Decimal         @db.Decimal(10, 2)
  reorderLevel Decimal?        @db.Decimal(10, 2)
  supplierId   String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  tenantId     String?
  batches      MaterialBatch[]
  usage        MaterialUsage[]
  supplier     Supplier?       @relation(fields: [supplierId], references: [id])
  tenant       Tenant?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("materials")
}

model MaterialUsage {
  id         String   @id @default(uuid())
  quantity   Decimal  @db.Decimal(10, 2)
  notes      String?
  usageDate  DateTime @default(now())
  materialId String
  projectId  String
  recordedBy String
  createdAt  DateTime @default(now())
  tenantId   String?
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [recordedBy], references: [id])
  tenant     Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("material_usage")
}

model MaterialBatch {
  id                String      @id @default(uuid())
  description       String
  descriptionAr     String?
  initialValue      Decimal     @db.Decimal(15, 2)
  remainingValue    Decimal     @db.Decimal(15, 2)
  status            BatchStatus @default(AVAILABLE)
  projectId         String
  originalReceiptId String?
  recordedBy        String
  purchaseDate      DateTime    @default(now())
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  tenantId          String
  materialId        String?
  material          Material?   @relation(fields: [materialId], references: [id])
  project           Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [recordedBy], references: [id])
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@map("material_batches")
}

model Workman {
  id           String        @id @default(uuid())
  name         String
  nameAr       String?
  trade        WorkmanTrade
  dailyRate    Decimal       @db.Decimal(10, 2)
  phone        String?
  nationalId   String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tenantId     String?
  totalPaid    Decimal       @default(0) @db.Decimal(15, 2)
  transactions Transaction[]
  workmanships Workmanship[]
  tenant       Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("workmen")
}

model Workmanship {
  id                String            @id @default(uuid())
  description       String
  descriptionAr     String?
  agreedAmount      Decimal           @db.Decimal(10, 2)
  paidAmount        Decimal           @default(0) @db.Decimal(10, 2)
  outstandingAmount Decimal           @default(0) @db.Decimal(10, 2)
  status            WorkmanshipStatus @default(PENDING)
  startDate         DateTime?
  completionDate    DateTime?
  workmanId         String
  projectId         String
  managedBy         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  tenantId          String?
  manager           User              @relation(fields: [managedBy], references: [id])
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant            Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workman           Workman           @relation(fields: [workmanId], references: [id], onDelete: Cascade)

  @@map("workmanships")
}

model Transaction {
  id              String              @id @default(uuid())
  type            TransactionType
  category        TransactionCategory
  amount          Decimal             @db.Decimal(15, 2)
  description     String
  descriptionAr   String?
  debit           Decimal?            @db.Decimal(15, 2)
  credit          Decimal?            @db.Decimal(15, 2)
  transactionDate DateTime            @default(now())
  paymentMethod   PaymentMethod       @default(BANK_TRANSFER)
  invoiceNumber   String?
  status          TransactionStatus   @default(DRAFT)
  notes           String?
  projectId       String?
  supplierId      String?
  clientId        String?
  createdBy       String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  aiExtractedData Json?
  aiRawText       String?
  approvedAt      DateTime?
  approvedBy      String?
  custodyWalletId String?
  receiptPhotoUrl String?
  rejectionReason String?
  tenantId        String?
  voiceNoteUrl    String?
  workmanId       String?
  approver        User?               @relation("ApprovedBy", fields: [approvedBy], references: [id])
  client          Client?             @relation(fields: [clientId], references: [id])
  user            User                @relation(fields: [createdBy], references: [id])
  project         Project?            @relation(fields: [projectId], references: [id])
  supplier        Supplier?           @relation(fields: [supplierId], references: [id])
  tenant          Tenant?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workman         Workman?            @relation(fields: [workmanId], references: [id])

  @@index([projectId, transactionDate])
  @@index([type, category])
  @@index([status])
  @@map("transactions")
}

model CustodyTransfer {
  id                   String              @id @default(uuid())
  type                 CustodyTransferType
  amount               Decimal             @db.Decimal(15, 2)
  description          String
  engineerId           String
  balanceBefore        Decimal             @db.Decimal(15, 2)
  balanceAfter         Decimal             @db.Decimal(15, 2)
  relatedTransactionId String?
  tenantId             String?
  createdAt            DateTime            @default(now())
  engineer             User                @relation(fields: [engineerId], references: [id])
  tenant               Tenant?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([engineerId, createdAt])
  @@map("custody_transfers")
}

model ChatMessage {
  id            String        @id @default(uuid())
  messageType   MessageType   @default(TEXT)
  content       String
  audioUrl      String?
  transcript    String?
  intent        MessageIntent @default(GENERAL)
  extractedData Json?
  processed     Boolean       @default(false)
  response      String?
  userId        String
  createdAt     DateTime      @default(now())
  tenantId      String?
  tenant        Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("chat_messages")
}

model Notification {
  id           String           @id @default(uuid())
  userId       String
  tenantId     String?
  type         NotificationType
  title        String
  message      String
  resourceId   String?
  resourceType String?
  isRead       Boolean          @default(false)
  createdAt    DateTime         @default(now())
  tenant       Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

model Document {
  id         String   @id @default(uuid())
  name       String
  url        String
  fileType   String?
  fileSize   Int?
  projectId  String
  uploadedAt DateTime @default(now())
  tenantId   String?
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant     Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Note {
  id        String   @id @default(uuid())
  content   String
  projectId String
  createdAt DateTime @default(now())
  tenantId  String?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("notes")
}

enum UserRole {
  ADMIN
  ENGINEER
  ACCOUNTANT
  SUPER_ADMIN
  PROJECT_MANAGER
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum SupplierCategory {
  MATERIALS
  EQUIPMENT
  SERVICES
  LABOR
  OTHER
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLACKLISTED
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectType {
  RESIDENTIAL
  COMMERCIAL
  INFRASTRUCTURE
  INDUSTRIAL
  OTHER
}

enum RevenueModel {
  DESIGN_ONLY_AREA
  EXECUTION_COST_PLUS
  EXECUTION_LUMP_SUM
}

enum MaterialUnit {
  M3
  TON
  KG
  M2
  M
  PIECE
  LITER
  BAG
}

enum BatchStatus {
  AVAILABLE
  PARTIALLY_USED
  CONSUMED
}

enum WorkmanTrade {
  CARPENTER
  MASON
  ELECTRICIAN
  PLUMBER
  PAINTER
  WELDER
  LABORER
  FOREMAN
  OTHER
  CONCRETE
  PLASTERER
  FLOORING
  GYPSUM
  ALUMINUM
}

enum WorkmanshipStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PAID
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionCategory {
  MATERIALS
  LABOR
  EQUIPMENT
  SERVICES
  PAYMENT
  OTHER
  CUSTODY_TRANSFER
}

enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CREDIT_CARD
  OTHER
  CUSTODY_WALLET
}

enum TransactionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  CANCELLED
}

enum CustodyTransferType {
  FUNDING
  CLEARANCE
  RETURN
}

enum MessageType {
  TEXT
  AUDIO
  COMMAND
}

enum MessageIntent {
  ADD_TRANSACTION
  ADD_PROJECT
  ADD_CLIENT
  ADD_SUPPLIER
  ADD_MATERIAL
  ADD_WORKMAN
  QUERY
  GENERAL
}

enum NotificationType {
  ACTION_REQUIRED
  INFO
  ALERT
}
